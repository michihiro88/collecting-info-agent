# テスト計画書（2025年3月10日 更新版）

## 1. テスト目的

本テスト計画は、情報収集エージェントの各コンポーネントが要件を満たし、安定して動作することを検証することを目的とします。特に、複数のAIモデルプロバイダーとの連携、環境変数の安全な管理、およびエラーハンドリングの堅牢性に焦点を当てます。

## 2. テスト範囲

### 2.1 単体テスト (Unit Tests)

- **AIモデルコンポーネント**: 各AIモデルプロバイダー（OpenAI、Anthropic、Google）の実装
- **設定管理**: 設定ファイルの読み込みと検証
- **環境変数管理**: 環境変数の安全なアクセスと検証
- **ユーティリティ関数**: ヘルパー関数やユーティリティの動作確認
- **エラーハンドリング**: 各種エラー状況での適切な処理と回復

### 2.2 統合テスト (Integration Tests)

- **AIモデル連携**: 複数のモデルを組み合わせた処理
- **検索機能連携**: 検索APIと情報処理の連携
- **設定と環境変数**: 設定と環境変数の連携動作
- **エラー伝播処理**: 各層でのエラー伝播と適切な処理

### 2.3 エンドツーエンドテスト (End-to-End Tests)

- **CLIインターフェース**: コマンドラインからの実行検証
- **APIインターフェース**: APIとしての利用時の動作検証
- **異常系シナリオ**: 外部サービス障害などの異常時の動作検証

## 3. 最新の実施状況と進捗（2025年3月10日更新）

### 3.1 テスト実行結果サマリー

**テスト実行日**: 2025年3月9日
**テスト結果**:
- 全テスト数: 156件
- 成功: 155件 (99.4%)
- スキップ: 1件 (0.6%)
- 失敗: 0件 (0%)

### 3.2 スキップされたテスト詳細

以下のテストがスキップされています：

- **ファイル**: `test/unit/models/google-model.test.ts`
- **テスト名**: `ストリーミングレスポンスが正しく処理される（統合テスト）`
- **スキップ理由**:
  1. このテストはストリーミングレスポンスの処理を検証する統合テストです
  2. ストリーミングAPIは単体テスト環境でのモックが技術的に難しい処理を含みます
  3. 実際のGoogleのAPIとの連携が必要であり、テスト環境では適切に再現できません
  4. リアルタイムのイベント処理やストリーミングの非同期処理は、Jest環境での検証が複雑です
  5. 単体テスト環境では、ストリーミングの動作を正確に検証するのは難しいため、
     将来的により適切な統合テスト環境で実装することを想定しています

### 3.3 エラーハンドリング機能の強化（完了）

エラーハンドリング機能を以下の分野で大幅に強化しました：

1. **RAGプロセッサーのエラー処理**
   - 検索機能のエラー処理強化（初期ステージと後続ステージのエラー処理差別化）
   - コンテンツ取得の個別エラー処理（1つのURLの取得失敗が全体処理に影響しないよう改善）
   - コンテンツ処理の個別エラー処理（部分的な処理失敗を許容）
   - 関連性スコアリングのエラー処理（スコアリング失敗時のフォールバックメカニズム）
   - コンテンツ統合時のエラー処理（基本的な結果形式を保証）

2. **コンテンツプロセッサーのエラー処理**
   - HTMLプロセッサーのエラー処理強化（DOM操作、メタデータ抽出、要素削除などの個別エラー処理）
   - PDFプロセッサーのエラーハンドリング強化（ファイル読み込み、解析、テキスト抽出などの堅牢化）
   - テキスト処理の各段階での個別エラー処理

3. **AIモデルインテグレーションのエラー処理**
   - モデルAPI呼び出しのエラーハンドリング（ネットワークエラー、タイムアウト、API制限など）
   - 各AIプロバイダーに特化したエラー処理
   - リトライメカニズムとフォールバック処理

### 3.4 エラーハンドリングテスト結果

エラーハンドリング機能の検証のために以下のテストを実施し、全て成功しました：

#### 3.4.1 単体テスト
- HTMLプロセッサーのエラー処理テスト：成功
- OpenAIプロバイダーのエラー処理テスト：成功
- モデルセレクターのエラー処理テスト：成功

#### 3.4.2 シミュレーションテスト
1. **検索エラーテスト**
   - シナリオ: 検索API呼び出しが失敗するケース
   - 結果: ✅ 成功（AppErrorが適切にキャッチされた）

2. **コンテンツ取得エラーテスト**
   - シナリオ: URLからのコンテンツ取得がタイムアウトするケース
   - 結果: ✅ 成功（一部のURLが取得できなくても処理は継続された）

3. **コンテンツ統合エラーテスト**
   - シナリオ: コンテンツの統合処理が失敗するケース
   - 結果: ✅ 成功（統合処理が失敗しても基本的な結果フォーマットは保持された）

### 3.5 テストモック改善の成果

テストの安定性と再現性を向上させるため、以下のモック改善を実施しました：

1. **SearchCache テスト**
   - キャッシュデータの構造を正しく模擬するようにモックを修正
   - テスト実行前にキャッシュを再ロードする処理を追加
   - 期待値の検証方法を修正

2. **OpenAIProvider テスト**
   - `handleError` メソッドをオーバーライドして例外をスローするように変更
   - モックの設定を修正し、エラーケースを適切に再現

3. **SearchAgent テスト**
   - `SearchService` の `fetchContent` メソッドをモックに追加
   - テストケースを修正して正しいモックメソッドを呼び出すように変更

4. **SearchService テスト**
   - モックの宣言順序を修正
   - `GoogleSearchProvider` のモックを直接 `jest.mock` 内で定義するように変更

### 3.6 今後のテスト課題

1. **テスト自動化の完全実現**
   - PowerShellスクリプトの問題修正
   - テスト結果の自動収集と報告機能の実装
   - CI/CD連携用のテスト自動化スクリプトの作成

2. **テストカバレッジの向上**
   - 現状のカバレッジ評価：約52.5%（全体）
   - 未カバーコードの特定と追加テスト実装
   - カバレッジレポートの自動生成

3. **スキップされているテストの実装**
   - ストリーミングレスポンスのテスト方法を再検討
   - 統合テスト環境での実装計画

## 4. 予定テスト

### 4.1 最新のテスト項目

#### 4.1.1 エラーハンドリング評価テスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 | 状態 |
|----|----------|---------|----------|---------|------|
| ERR-1 | 検索エンジンAPI接続エラー | モックAPI環境 | 検索サービスでの接続エラーをシミュレート | エラーが適切に処理され、ユーザーに通知される | **完了 ✓** |
| ERR-2 | コンテンツ取得タイムアウト | モックURL | URLからのコンテンツ取得時のタイムアウトをシミュレート | 処理が継続され、取得できたURLのみ処理される | **完了 ✓** |
| ERR-3 | コンテンツ処理エラー | 不正フォーマットデータ | 処理不可能なフォーマットのコンテンツを与える | エラーログが記録され、可能な限り処理が続行される | **完了 ✓** |
| ERR-4 | モデルAPI認証エラー | 不正なAPIキー | 不正なAPIキーでモデルAPIを呼び出す | 認証エラーが適切に処理され、代替モデルが使用される | **完了 ✓** |
| ERR-5 | レート制限エラー | モックAPIレート制限 | APIレート制限をシミュレート | 待機とリトライ処理が正しく動作する | **完了 ✓** |
| ERR-6 | 統合エラー | モック統合エラー | 複数コンテンツの統合処理でエラー発生 | フォールバック結果が返される | **完了 ✓** |
| ERR-7 | ネットワーク切断 | ネットワーク切断環境 | 処理中のネットワーク切断をシミュレート | 適切なエラーメッセージとリカバリー処理が実行される | **完了 ✓** |

#### 4.1.2 テスト自動化課題

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 | 状態 |
|----|----------|---------|----------|---------|------|
| AUTO-1 | PowerShellスクリプト互換性 | Windows/Linux環境 | 同一スクリプトを複数環境で実行 | 全環境で正しく動作する | 優先実施 |
| AUTO-2 | テスト結果自動収集 | テスト実行環境 | テスト実行とログ収集を自動化 | 構造化されたテスト結果レポートが生成される | 予定 |
| AUTO-3 | CI/CD連携テスト | CI環境 | CI環境でのテスト自動実行 | テスト結果が自動的に報告される | 予定 |
| AUTO-4 | クロスプラットフォームテスト | 複数OS環境 | 多環境でのテスト実行 | 全環境で一貫した結果が得られる | 予定 |

#### 4.1.3 カスタムスコアリング評価テスト（第3フェーズ）

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 | 状態 |
|----|----------|---------|----------|---------|------|
| SCORE-1 | ドメイン特化スコアリング | 特定ドメインのデータセット | ドメイン特化型スコアリングを実行 | 特定領域での関連性スコアが向上する | 予定 |
| SCORE-2 | フィードバックスコア調整 | フィードバックデータ | フィードバック反映処理を実行 | フィードバックに基づくスコア調整が機能する | 予定 |
| SCORE-3 | スコアリング性能比較 | 標準データセット | 複数スコアリングアルゴリズムを比較 | 最適なアルゴリズムが特定できる | 予定 |

### 4.2 エージェント機能拡張テスト（第3フェーズ）

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 | 状態 |
|----|----------|---------|----------|---------|------|
| AGT-MON-1 | エージェント状態監視 | 監視設定 | エージェント実行中の状態変化を監視 | 状態変化が適切に検出される | 予定 |
| AGT-MON-2 | エラー発生時の自動復旧 | エラー発生環境 | 復旧可能なエラーを発生させる | 自動的に復旧処理が実行される | 予定 |
| AGT-MON-3 | タスク再開機能 | 中断状態 | 中断タスクの再開を試行 | 中断したポイントから処理が再開される | 予定 |
| AGT-HIST-1 | クエリ履歴保存 | 履歴機能有効 | 複数クエリを実行し履歴を確認 | クエリと結果が正しく保存される | 予定 |
| AGT-HIST-2 | 類似クエリ検出 | 履歴データ | 類似クエリを実行 | 既存結果の再利用が提案される | 予定 |

## 5. テスト実行計画

### 5.1 短期テスト計画（第2フェーズ: テスト自動化の完全実現）

| テストID | 説明 | 予定日 | 担当者 | 優先度 |
|---------|-----|-------|-------|-------|
| AUTO-1 | PowerShellスクリプト互換性テスト | 2025/3/15-16 | DevOpsチーム | 高 |
| AUTO-2 | テスト結果自動収集テスト | 2025/3/17-19 | DevOpsチーム | 中 |
| AUTO-3 | CI/CD連携テスト | 2025/3/20-21 | DevOpsチーム | 中 |
| AUTO-4 | クロスプラットフォームテスト | 2025/3/22 | DevOpsチーム | 低 |

### 5.2 中期テスト計画（第3フェーズ: 機能拡張と最適化）

| テストID | 説明 | 予定日 | 担当者 | 優先度 |
|---------|-----|-------|-------|-------|
| SCORE-1~3 | カスタムスコアリングテスト | 2025/4/1-7 | QAチーム | 中 |
| AGT-MON-1~3 | エージェント監視機能テスト | 2025/4/8-12 | QAチーム | 高 |
| AGT-HIST-1~2 | クエリ履歴管理テスト | 2025/4/13-16 | QAチーム | 中 |

### 5.3 長期テスト計画（第4フェーズ: ドキュメント整備と品質向上）

| 活動 | 説明 | 予定日 | 担当者 | 優先度 |
|-----|-----|-------|-------|-------|
| テストカバレッジ評価 | 現状のテストカバレッジを計測 | 2025/4/22 | QAチーム | 高 |
| 追加テスト実装 | 未カバー領域のテスト実装 | 2025/4/23-26 | 開発チーム | 高 |
| カバレッジレポート作成 | カバレッジレポート自動生成 | 2025/4/27-28 | DevOpsチーム | 中 |
| パフォーマンステスト | システム全体の負荷テスト | 2025/4/29 | QAチーム | 中 |

## 6. テスト環境

### 6.1 開発環境

- Node.js 16+
- TypeScript 4.5+
- Jest (テストフレームワーク)
- Windows 11 / macOS / Linux

### 6.2 テストデータ

- モックAPIレスポンス
- サンプルプロンプト
- テスト用設定ファイル
- テスト用環境変数
- エラーシミュレーションデータセット

### 6.3 CI/CD環境（予定）

- GitHub Actions
- テスト結果保存用リポジトリ
- Slack/Teams通知連携

## 7. テスト実施上の考慮事項

### 7.1 エラーハンドリングテストの注意点

1. **テスト用モックの実行環境対応**
   - Jestモックと実行環境用スタブの分離
   - オリジナルの関数保存と復元パターンの活用

2. **エラーシミュレーションの再現性確保**
   - 一貫したエラー状態をシミュレートする手法
   - テスト間の独立性維持

3. **グレースフルデグラデーションの検証**
   - 段階的機能低下の正しい評価方法
   - ユーザーエクスペリエンス観点からの検証

### 7.2 テスト自動化実現のポイント

1. **テスト実行環境設定の標準化**
   - 環境変数とAPIキーの安全な管理
   - 依存ライブラリの固定バージョン化

2. **テスト結果の構造化**
   - JSONベースの統一フォーマット
   - 時系列データとしての保存
   - 傾向分析が可能なデータ構造

3. **障害通知の最適化**
   - 優先度に基づくアラート通知
   - 詳細情報へのリンク
   - トリアージ情報の付加

## 8. スキップされているテストの今後の計画

現在スキップされている「ストリーミングレスポンスが正しく処理される（統合テスト）」については、以下の計画で対応する予定です：

1. **短期対応（2025年4月）**:
   - ストリーミングテスト用の専用モックライブラリの評価
   - 非同期イベントストリームのテスト手法の調査

2. **中期対応（2025年5月）**:
   - 統合テスト環境でのストリーミングテスト実装
   - 実APIを使用した結合テストの実装（環境分離）

3. **長期対応（2025年6月）**:
   - ストリーミングテストの自動化
   - CI/CD環境でのストリーミングテスト実行

## 9. 更新履歴

| 日付 | バージョン | 内容 | 更新者 |
|------|----------|------|--------|
| 2023-06-01 | 0.1 | 初版作成 | 開発チーム |
| 2023-08-15 | 0.2 | AIモデルテスト追加 | 開発チーム |
| 2023-10-20 | 0.3 | 環境変数管理テスト追加 | 開発チーム |
| 2024-03-07 | 1.0 | テスト実行結果の反映と環境変数管理の強化 | 開発チーム |
| 2024-03-08 | 1.1 | コンテンツ処理機能とAI要約生成機能のテスト計画追加 | 開発チーム |
| 2024-03-08 | 1.2 | コンテンツプロセッサーテスト結果の反映 | 開発チーム |
| 2024-03-08 | 1.3 | RAG機能とエージェント連携テスト計画の追加 | 開発チーム |
| 2024-03-08 | 1.4 | RAG機能とエージェント連携テスト実行結果の反映 | 開発チーム |
| 2025-03-08 | 1.5 | 設定ファイル問題の解決と検索・URL処理テスト結果の反映 | 開発チーム |
| 2025-03-08 | 1.6 | テストスクリプトのプロセス自動終了機能の追加 | 開発チーム |
| 2025-03-09 | 1.7 | エラーハンドリングテスト結果の反映と今後のテスト計画更新 | 開発チーム |
| 2025-03-10 | 1.8 | スキップされたテストの分析と対応計画の追加、最新テスト実行結果反映 | 開発チーム | 