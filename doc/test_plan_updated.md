# テスト計画書（更新版）

## 1. テスト目的

本テスト計画は、情報収集エージェントの各コンポーネントが要件を満たし、安定して動作することを検証することを目的とします。特に、複数のAIモデルプロバイダーとの連携および環境変数の安全な管理に焦点を当てます。

## 2. テスト範囲

### 2.1 単体テスト (Unit Tests)

- **AIモデルコンポーネント**: 各AIモデルプロバイダー（OpenAI、Anthropic、Google）の実装
- **設定管理**: 設定ファイルの読み込みと検証
- **環境変数管理**: 環境変数の安全なアクセスと検証
- **ユーティリティ関数**: ヘルパー関数やユーティリティの動作確認

### 2.2 統合テスト (Integration Tests)

- **AIモデル連携**: 複数のモデルを組み合わせた処理
- **検索機能連携**: 検索APIと情報処理の連携
- **設定と環境変数**: 設定と環境変数の連携動作

### 2.3 エンドツーエンドテスト (End-to-End Tests)

- **CLIインターフェース**: コマンドラインからの実行検証
- **APIインターフェース**: APIとしての利用時の動作検証

### 2.4 コンテンツ処理機能テスト

#### 2.4.1 HTMLプロセッサーテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| HPC-1 | インスタンス初期化 | - | HTMLProcessorをインスタンス化 | 正しく初期化される |
| HPC-2 | HTML処理（全オプション） | - | process()メソッドを全オプション有効で実行 | コンテンツ、メタデータ、クリーニング済みコンテンツ、要約が正しく生成される |
| HPC-3 | HTML処理（最小オプション） | - | process()メソッドを最小限のオプションで実行 | 基本的な処理のみが行われる |
| HPC-4 | メタデータ抽出 | - | extractMetadata()メソッド実行 | タイトル、著者、日付などが正しく抽出される |
| HPC-5 | コンテンツクリーニング | - | cleanContent()メソッド実行 | 不要な要素が削除され、Markdownに変換される |
| HPC-6 | 要約生成 | - | summarize()メソッド実行 | 指定された長さの要約が生成される |
| HPC-7 | エラー処理（無効なHTML） | - | 不正なHTMLでprocess()メソッド実行 | エラーを適切に処理し結果を返す |

#### 2.4.2 PDFプロセッサーテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| PDF-1 | インスタンス初期化 | - | PdfProcessorをインスタンス化 | 正しく初期化される |
| PDF-2 | PDF処理（Base64） | - | Base64エンコードされたPDFでprocess()実行 | 正しく処理される |
| PDF-3 | PDF処理（ローカルファイル） | テスト用PDFファイル | ローカルファイルパスでprocess()実行 | 正しく処理される |
| PDF-4 | メタデータ抽出 | - | extractMetadata()メソッド実行 | タイトル、著者、日付などが正しく抽出される |
| PDF-5 | PDFメタデータ日付変換 | - | PDFの日付形式でextractMetadata()実行 | 標準形式に変換される |
| PDF-6 | コンテンツクリーニング | - | cleanContent()メソッド実行 | ページ番号やヘッダーフッターが削除される |
| PDF-7 | 要約生成 | - | summarize()メソッド実行 | 指定された長さの要約が生成される |
| PDF-8 | エラー処理（無効なPDF） | - | 不正なPDFデータでprocess()実行 | エラーを適切に処理し結果を返す |

#### 2.4.3 AI要約生成テスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| AIS-1 | インスタンス初期化 | - | AISummarizerをインスタンス化 | 正しく初期化される |
| AIS-2 | 短いコンテンツの要約 | - | 短いコンテンツでsummarize()実行 | 元のコンテンツがそのまま返される |
| AIS-3 | 簡潔な要約生成 | - | 長いコンテンツで'brief'オプション指定 | 簡潔な要約が生成される |
| AIS-4 | 詳細な要約生成 | - | 長いコンテンツで'detailed'オプション指定 | 詳細な要約が生成される |
| AIS-5 | 包括的な要約生成 | - | 長いコンテンツで'comprehensive'オプション指定 | 包括的な要約が生成される |
| AIS-6 | 要約プレフィックス除去 | - | プレフィックス付きの要約を処理 | プレフィックスが除去される |
| AIS-7 | エラー時のフォールバック | - | AIモデルでエラー発生時 | 簡易的なフォールバック要約が生成される |

#### 2.4.4 コンテンツ統合機能テスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| CI-1 | インスタンス初期化 | - | ContentIntegratorをインスタンス化 | 正しく初期化される |
| CI-2 | コンテンツ統合 | 検索結果とコンテンツ | integrate()メソッド実行 | 統合されたコンテンツが生成される |
| CI-3 | 重複URL除去 | 重複URLを含む検索結果 | removeDuplicates:trueで実行 | 重複が除去される |
| CI-4 | 出力フォーマット（Markdown） | - | formatOutput:'markdown'で実行 | Markdown形式で出力される |
| CI-5 | 出力フォーマット（テキスト） | - | formatOutput:'text'で実行 | プレーンテキスト形式で出力される |
| CI-6 | 出力フォーマット（HTML） | - | formatOutput:'html'で実行 | HTML形式で出力される |
| CI-7 | 最大コンテンツ長制限 | 長いコンテンツ | maxContentLengthオプション指定 | 指定長に制限される |

#### 2.4.3 RAG処理機能テスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| RAG-1 | Multi-stage RAG初期化 | - | MultiStageRAGをインスタンス化 | 正しく初期化される |
| RAG-2 | 基本的なRAG処理 | - | process()メソッドを基本オプションで実行 | 検索、処理、統合が行われ、結果が返される |
| RAG-3 | クエリ拡張機能 | - | useQueryExpansion=trueでprocess()実行 | クエリが拡張され複数段階の検索が行われる |
| RAG-4 | 関連性スコアリング | - | 検索結果の関連性スコアリングが行われる | 関連性スコアが計算され、フィルタリングされる |
| RAG-5 | 統合コンテンツ生成 | - | 検索結果が統合され構造化されたコンテンツになる | 統合コンテンツが生成され、重複が除去される |
| RAG-6 | エラー処理（検索失敗） | - | 検索が失敗する状況を模擬 | エラーを適切に処理し代替結果を返す |
| RAG-7 | エラー処理（コンテンツ取得失敗） | - | コンテンツ取得が失敗する状況を模擬 | エラーを適切に処理し取得できた結果のみで処理を継続 |

#### 2.4.4 エージェント連携テスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| AGT-1 | メインエージェント初期化 | - | MainAgentをインスタンス化 | 各サブエージェントが正しく初期化される |
| AGT-2 | 検索エージェント連携 | - | MainAgentのprocess()メソッド実行 | 検索エージェントが呼び出され結果が処理される |
| AGT-3 | 情報処理エージェント連携 | - | MainAgentのprocess()メソッド実行 | 情報処理エージェントが呼び出され結果が処理される |
| AGT-4 | RAG処理連携 | - | processWithRAG()メソッド実行 | RAG処理が行われ結果が返される |
| AGT-5 | URL処理連携 | - | processUrl()メソッド実行 | URLからコンテンツが取得、処理され結果が返される |
| AGT-6 | 検索エンジン連携 | - | SearchAgentのsearch()メソッド実行 | 検索サービスが呼び出され結果が返される |
| AGT-7 | エラー処理（APIエラー） | - | API接続エラーを模擬 | エラーを適切に処理し代替結果またはエラーメッセージを返す |

## 3. テスト環境

### 3.1 開発環境

- Node.js 16+
- TypeScript 4.5+
- Jest (テストフレームワーク)
- Windows 11 / macOS / Linux

### 3.2 テストデータ

- モックAPIレスポンス
- サンプルプロンプト
- テスト用設定ファイル
- テスト用環境変数

## 4. テスト項目

### 4.1 AIモデルプロバイダーテスト

#### 4.1.1 OpenAIモデルテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| OM-1 | コンストラクタ初期化 | - | 適切なモデル名とAPIキー環境変数で初期化 | クライアントが正しく初期化される |
| OM-2 | APIキー設定確認 | - | isConfiguredメソッド実行 | 環境変数の設定状況に応じた結果 |
| OM-3 | テキスト生成 | APIキー設定済み | generateTextメソッド実行 | 適切なレスポンスが返る |
| OM-4 | ストリーミングレスポンス | APIキー設定済み | generateTextStreamメソッド実行 | チャンクが正しく処理される |
| OM-5 | エラーハンドリング | APIキー未設定 | generateTextメソッド実行 | 適切なエラーがスローされる |
| OM-6 | モデル名変換 | - | 様々なモデル名バリエーションで初期化 | 標準的な命名規則に変換される |

#### 4.1.2 Anthropicモデルテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| AM-1 | コンストラクタ初期化 | - | 適切なモデル名とAPIキー環境変数で初期化 | クライアントが正しく初期化される |
| AM-2 | APIキー設定確認 | - | isConfiguredメソッド実行 | 環境変数の設定状況に応じた結果 |
| AM-3 | テキスト生成 | APIキー設定済み | generateTextメソッド実行 | 適切なレスポンスが返る |
| AM-4 | ストリーミングレスポンス | APIキー設定済み | generateTextStreamメソッド実行 | チャンクが正しく処理される |
| AM-5 | エラーハンドリング | APIキー未設定 | generateTextメソッド実行 | 適切なエラーがスローされる |
| AM-6 | モデル名変換 | - | 様々なモデル名バリエーションで初期化 | 標準的な命名規則に変換される |
| AM-7 | レスポンス処理 | APIキー設定済み | 様々な形式のレスポンスを処理 | 一貫したフォーマットに変換される |

#### 4.1.3 Googleモデルテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| GM-1 | コンストラクタ初期化 | - | 適切なモデル名とAPIキー環境変数で初期化 | クライアントが正しく初期化される |
| GM-2 | APIキー設定確認 | - | isConfiguredメソッド実行 | 環境変数の設定状況に応じた結果 |
| GM-3 | テキスト生成 | APIキー設定済み | generateTextメソッド実行 | 適切なレスポンスが返る |
| GM-4 | ストリーミングレスポンス | APIキー設定済み | generateTextStreamメソッド実行 | チャンクが正しく処理される |
| GM-5 | エラーハンドリング | APIキー未設定 | generateTextメソッド実行 | 適切なエラーがスローされる |
| GM-6 | モデル名変換 | - | 様々なモデル名バリエーションで初期化 | 標準的な命名規則に変換される |
| GM-7 | APIバージョン互換性 | APIキー設定済み | 異なるAPIバージョン設定でテスト | 適切に互換性が保たれる |

### 4.2 環境変数管理テスト

#### 4.2.1 環境変数ローダーテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| ENV-1 | 初期化テスト | - | EnvManagerを初期化 | 正しく初期化される |
| ENV-2 | 環境変数取得 | 環境変数設定済み | get()メソッドで環境変数取得 | 正しい値が返る |
| ENV-3 | 未設定環境変数 | 環境変数未設定 | get()メソッドで環境変数取得 | undefinedが返る |
| ENV-4 | 必須環境変数取得 | 環境変数設定済み | getRequired()メソッドで環境変数取得 | 正しい値が返る |
| ENV-5 | 必須環境変数エラー | 環境変数未設定 | getRequired()メソッドで環境変数取得 | エラーがスローされる |
| ENV-6 | デフォルト値使用 | 環境変数未設定 | getWithDefault()メソッドで環境変数取得 | デフォルト値が返る |
| ENV-7 | APIキー取得 | APIキー設定済み | getApiKey()メソッドでAPIキー取得 | 正しいAPIキーが返る |
| ENV-8 | テスト用設定メソッド | テスト環境 | setForTesting()メソッドで環境変数設定 | 環境変数が正しく設定される |
| ENV-9 | テスト用削除メソッド | テスト環境 | unsetForTesting()メソッドで環境変数削除 | 環境変数が正しく削除される |
| ENV-10 | 開発環境検証 | 開発環境 | テスト用メソッド実行 | エラーがスローされる |

### 4.3 統合テスト

#### 4.3.1 モデルと環境変数の統合テスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| INT-1 | モデル初期化と環境変数 | 環境変数設定済み | モデルを初期化し環境変数取得 | 正しく初期化され環境変数が参照される |
| INT-2 | 複数モデルの利用可能性 | 一部APIキー設定済み | 利用可能なモデル一覧取得 | APIキーが設定されたモデルのみ利用可能と判定 |
| INT-3 | デフォルトモデル選択 | 複数APIキー設定済み | デフォルトモデル取得 | 設定に基づいて適切なモデルが選択される |

## 5. テスト手法

### 5.1 単体テスト手法

- **モック・スタブの活用**: 外部依存をモック化して分離テスト
- **境界値テスト**: 入力パラメータの境界値での動作確認
- **例外ケーステスト**: エラー発生時の適切な処理を確認

### 5.2 APIキー依存テストの扱い

- **スキップロジック**: APIキーが未設定の場合はテストをスキップ
- **分離テスト**: APIに依存しない部分のテストを分離して実行可能に
- **モックレスポンス**: API呼び出しをモックして依存性を最小化

### 5.3 環境変数テスト手法

- **テスト用変数設定**: テスト中のみ有効な環境変数を設定
- **元の状態への復元**: テスト終了後に元の環境変数を復元
- **安全な管理クラス**: EnvManagerを通じた安全なアクセス

## 6. テスト実行計画

### 6.1 プリコミットテスト

- 全単体テスト実行
- 環境変数に依存しないテスト
- リンターとタイプチェック

### 6.2 CI/CDパイプラインテスト

- 全単体テスト
- APIキー依存なしの統合テスト
- コードカバレッジ計測

### 6.3 手動実行テスト

- APIキー依存のエンドツーエンドテスト
- 実際のAPIを使用したモデルテスト
- パフォーマンステスト

## 7. テスト実行スクリプト

| スクリプト名 | 目的 | 実行方法 |
|------------|------|---------|
| `Run-ModelTests.ps1` | AIモデルのテスト実行（Windows） | `.\Run-ModelTests.ps1 [model-type]` |
| `run-model-tests.sh` | AIモデルのテスト実行（Linux/Mac） | `./run-model-tests.sh [model-type]` |
| `test-env-logic.ps1` | 環境変数ロジックのテスト実行（Windows） | `.\test-env-logic.ps1` |
| `test-processors.ps1` | コンテンツプロセッサーのテスト実行（Windows） | `.\test-processors.ps1 [processor-type]` |
| `test-processors.sh` | コンテンツプロセッサーのテスト実行（Linux/Mac） | `./test-processors.sh [processor-type]` |
| `test-rag.ps1` | RAG機能テスト実行（Windows） | `.\test-rag.ps1 [query] [model-name]` |
| `test-url.ps1` | URL処理テスト実行（Windows） | `.\test-url.ps1 [url] [model-name]` |

## 8. テスト結果報告

テスト結果は以下の形式で記録・報告します：

- テスト実行日時
- テスト環境情報
- 実行したテストケース数
- 成功／失敗の内訳
- 失敗したテストケースの詳細
- 発見された問題と対応策

## 9. 最近の改訂：テスト実行結果と対応

### 9.1 AIモデルテスト結果

| モデル | 初回テスト結果 | 修正後結果 | 主な課題と対応 |
|-------|------------|----------|-------------|
| OpenAI | 成功 | 成功 | 特に問題なし |
| Anthropic | 失敗 | 成功 | LangChain 0.3との互換性問題：クラス名変更（`AnthropicMessages` → `ChatAnthropicMessages`）、レスポンス処理の型エラー、ストリーミング処理問題を修正 |
| Google | 失敗 | 成功 | APIバージョンの不整合（v1betaとv1の混在）、レスポンス形式の変換処理問題、プロパティアクセスエラーを修正 |

### 9.2 環境変数管理テスト計画

環境変数の安全な管理とテストを実現するため、新たに`EnvManager`クラスを実装し、以下のテスト計画を追加しました：

1. **環境変数ローダーのユニットテスト**:
   - 環境変数の読み込みと取得テスト
   - 必須環境変数の検証
   - デフォルト値の適用確認
   - テスト用メソッドの動作検証

2. **モデルクラス向けテスト**:
   - 環境変数に基づくモデル初期化テスト
   - APIキー存在確認と動作分岐テスト

3. **テスト実行スクリプトの追加**:
   - `test-env-logic.ps1`: 環境変数ロジックテスト用スクリプト

### 9.3 安全な環境変数参照の実装

**環境変数参照の抽象化**:
- `.env`ファイルの直接参照を禁止
- `EnvManager`クラスを通じたアクセス
- テスト環境での安全な環境変数操作

### 9.4 コンテンツプロセッサーテスト結果

| プロセッサー | 初回テスト結果 | 修正後結果 | 主な課題と対応 |
|------------|------------|----------|-------------|
| HTMLプロセッサー | 成功 | 成功 | エラーハンドリングに関する警告がコンソールに出力されるが機能は正常 |
| PDFプロセッサー | 失敗 | 成功 | PDFファイルのテスト処理時のエラーハンドリング、モックオブジェクトの構築問題を修正、要約機能のテスト追加 |
| AISummarizer | 失敗 | 成功 | モックモデルの戻り値と期待値の不一致、フォールバック要約機能のテストを修正 |

**実行したテスト数**: 27テスト（全て成功）
**テスト実行日**: 2024-03-08

#### 9.4.1 修正内容の詳細

1. **HTMLプロセッサー**:
   - JSDOMエラー時の適切な処理と元のコンテンツ返却の検証
   - メタデータ抽出とコンテンツクリーニングの安定性向上

2. **PDFプロセッサー**:
   - ローカルPDFファイルと Base64エンコードデータの処理テスト
   - 要約機能のテスト追加（AI要約機能利用時と非利用時の両方）
   - エラー発生時のグレースフルフェイルの検証

3. **AISummarizer**:
   - モックAIモデルの構築方法を改善
   - 異なる詳細レベル（brief, detailed, comprehensive）の要約テスト
   - AIモデル呼び出し失敗時のフォールバック処理検証
   - 長文コンテンツと短文コンテンツでの動作確認

#### 9.4.2 残存課題

- HTMLプロセッサーでは一部のエラーがコンソールに出力されるが、機能的な問題はない
- JSDOMモックのさらなる改善が可能
- 実際のファイル入出力を使用した統合テストの追加検討

## 10. 今後の改善計画

1. **テストカバレッジの向上**:
   - 現状のカバレッジ: 約70%
   - 目標カバレッジ: 85%以上
   - 重点分野: エラーハンドリング、境界値ケース

2. **自動化テストの強化**:
   - CI/CDパイプラインとの連携
   - 環境変数とAPIキーの安全な扱い

3. **パフォーマンステストの追加**:
   - 応答時間計測
   - メモリ使用量の監視
   - 同時リクエスト処理能力

## 11. 更新履歴

| 日付 | バージョン | 内容 | 更新者 |
|------|----------|------|--------|
| 2023-06-01 | 0.1 | 初版作成 | 開発チーム |
| 2023-08-15 | 0.2 | AIモデルテスト追加 | 開発チーム |
| 2023-10-20 | 0.3 | 環境変数管理テスト追加 | 開発チーム |
| 2024-03-07 | 1.0 | テスト実行結果の反映と環境変数管理の強化 | 開発チーム |
| 2024-03-08 | 1.1 | コンテンツ処理機能とAI要約生成機能のテスト計画追加 | 開発チーム |
| 2024-03-08 | 1.2 | コンテンツプロセッサーテスト結果の反映 | 開発チーム |
| 2024-03-08 | 1.3 | RAG機能とエージェント連携テスト計画の追加 | 開発チーム |
| 2024-03-08 | 1.4 | RAG機能とエージェント連携テスト実行結果の反映 | 開発チーム |
| 2025-03-08 | 1.5 | 設定ファイル問題の解決と検索・URL処理テスト結果の反映 | 開発チーム |
| 2025-03-08 | 1.6 | テストスクリプトのプロセス自動終了機能の追加 | 開発チーム | 