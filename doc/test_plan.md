# テスト計画書

## 1. テスト目的

本テスト計画は、情報収集エージェントの各コンポーネントが要件を満たし、安定して動作することを検証することを目的とします。特に、複数のAIモデルプロバイダーとの連携および環境変数の安全な管理に焦点を当てます。

## 2. テスト範囲

### 2.1 単体テスト (Unit Tests)

- **AIモデルコンポーネント**: 各AIモデルプロバイダー（OpenAI、Anthropic、Google）の実装
- **設定管理**: 設定ファイルの読み込みと検証
- **環境変数管理**: 環境変数の安全なアクセスと検証
- **ユーティリティ関数**: ヘルパー関数やユーティリティの動作確認

### 2.2 統合テスト (Integration Tests)

- **AIモデル連携**: 複数のモデルを組み合わせた処理
- **検索機能連携**: 検索APIと情報処理の連携
- **設定と環境変数**: 設定と環境変数の連携動作

### 2.3 エンドツーエンドテスト (End-to-End Tests)

- **CLIインターフェース**: コマンドラインからの実行検証
- **APIインターフェース**: APIとしての利用時の動作検証

## 3. テスト環境

### 3.1 開発環境

- Node.js 16+
- TypeScript 4.5+
- Jest (テストフレームワーク)
- Windows 11 / macOS / Linux

### 3.2 テストデータ

- モックAPIレスポンス
- サンプルプロンプト
- テスト用設定ファイル
- テスト用環境変数

## 4. テスト項目

### 4.1 AIモデルプロバイダーテスト

#### 4.1.1 OpenAIモデルテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| OM-1 | コンストラクタ初期化 | - | 適切なモデル名とAPIキー環境変数で初期化 | クライアントが正しく初期化される |
| OM-2 | APIキー設定確認 | - | isConfiguredメソッド実行 | 環境変数の設定状況に応じた結果 |
| OM-3 | テキスト生成 | APIキー設定済み | generateTextメソッド実行 | 適切なレスポンスが返る |
| OM-4 | ストリーミングレスポンス | APIキー設定済み | generateTextStreamメソッド実行 | チャンクが正しく処理される |
| OM-5 | エラーハンドリング | APIキー未設定 | generateTextメソッド実行 | 適切なエラーがスローされる |
| OM-6 | モデル名変換 | - | 様々なモデル名バリエーションで初期化 | 標準的な命名規則に変換される |

#### 4.1.2 Anthropicモデルテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| AM-1 | コンストラクタ初期化 | - | 適切なモデル名とAPIキー環境変数で初期化 | クライアントが正しく初期化される |
| AM-2 | APIキー設定確認 | - | isConfiguredメソッド実行 | 環境変数の設定状況に応じた結果 |
| AM-3 | テキスト生成 | APIキー設定済み | generateTextメソッド実行 | 適切なレスポンスが返る |
| AM-4 | ストリーミングレスポンス | APIキー設定済み | generateTextStreamメソッド実行 | チャンクが正しく処理される |
| AM-5 | エラーハンドリング | APIキー未設定 | generateTextメソッド実行 | 適切なエラーがスローされる |
| AM-6 | モデル名変換 | - | 様々なモデル名バリエーションで初期化 | 標準的な命名規則に変換される |
| AM-7 | レスポンス処理 | APIキー設定済み | 様々な形式のレスポンスを処理 | 一貫したフォーマットに変換される |

#### 4.1.3 Googleモデルテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| GM-1 | コンストラクタ初期化 | - | 適切なモデル名とAPIキー環境変数で初期化 | クライアントが正しく初期化される |
| GM-2 | APIキー設定確認 | - | isConfiguredメソッド実行 | 環境変数の設定状況に応じた結果 |
| GM-3 | テキスト生成 | APIキー設定済み | generateTextメソッド実行 | 適切なレスポンスが返る |
| GM-4 | ストリーミングレスポンス | APIキー設定済み | generateTextStreamメソッド実行 | チャンクが正しく処理される |
| GM-5 | エラーハンドリング | APIキー未設定 | generateTextメソッド実行 | 適切なエラーがスローされる |
| GM-6 | モデル名変換 | - | 様々なモデル名バリエーションで初期化 | 標準的な命名規則に変換される |
| GM-7 | APIバージョン互換性 | APIキー設定済み | 異なるAPIバージョン設定でテスト | 適切に互換性が保たれる |

### 4.2 環境変数管理テスト

#### 4.2.1 環境変数ローダーテスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| ENV-1 | 初期化テスト | - | EnvManagerを初期化 | 正しく初期化される |
| ENV-2 | 環境変数取得 | 環境変数設定済み | get()メソッドで環境変数取得 | 正しい値が返る |
| ENV-3 | 未設定環境変数 | 環境変数未設定 | get()メソッドで環境変数取得 | undefinedが返る |
| ENV-4 | 必須環境変数取得 | 環境変数設定済み | getRequired()メソッドで環境変数取得 | 正しい値が返る |
| ENV-5 | 必須環境変数エラー | 環境変数未設定 | getRequired()メソッドで環境変数取得 | エラーがスローされる |
| ENV-6 | デフォルト値使用 | 環境変数未設定 | getWithDefault()メソッドで環境変数取得 | デフォルト値が返る |
| ENV-7 | APIキー取得 | APIキー設定済み | getApiKey()メソッドでAPIキー取得 | 正しいAPIキーが返る |
| ENV-8 | テスト用設定メソッド | テスト環境 | setForTesting()メソッドで環境変数設定 | 環境変数が正しく設定される |
| ENV-9 | テスト用削除メソッド | テスト環境 | unsetForTesting()メソッドで環境変数削除 | 環境変数が正しく削除される |
| ENV-10 | 開発環境検証 | 開発環境 | テスト用メソッド実行 | エラーがスローされる |

### 4.3 統合テスト

#### 4.3.1 モデルと環境変数の統合テスト

| ID | テスト項目 | 前提条件 | テスト手順 | 期待結果 |
|----|----------|---------|----------|---------|
| INT-1 | モデル初期化と環境変数 | 環境変数設定済み | モデルを初期化し環境変数取得 | 正しく初期化され環境変数が参照される |
| INT-2 | 複数モデルの利用可能性 | 一部APIキー設定済み | 利用可能なモデル一覧取得 | APIキーが設定されたモデルのみ利用可能と判定 |
| INT-3 | デフォルトモデル選択 | 複数APIキー設定済み | デフォルトモデル取得 | 設定に基づいて適切なモデルが選択される |

## 5. テスト手法

### 5.1 単体テスト手法

- **モック・スタブの活用**: 外部依存をモック化して分離テスト
- **境界値テスト**: 入力パラメータの境界値での動作確認
- **例外ケーステスト**: エラー発生時の適切な処理を確認

### 5.2 APIキー依存テストの扱い

- **スキップロジック**: APIキーが未設定の場合はテストをスキップ
- **分離テスト**: APIに依存しない部分のテストを分離して実行可能に
- **モックレスポンス**: API呼び出しをモックして依存性を最小化

### 5.3 環境変数テスト手法

- **テスト用変数設定**: テスト中のみ有効な環境変数を設定
- **元の状態への復元**: テスト終了後に元の環境変数を復元
- **安全な管理クラス**: EnvManagerを通じた安全なアクセス

## 6. テスト実行計画

### 6.1 プリコミットテスト

- 全単体テスト実行
- 環境変数に依存しないテスト
- リンターとタイプチェック

### 6.2 CI/CDパイプラインテスト

- 全単体テスト
- APIキー依存なしの統合テスト
- コードカバレッジ計測

### 6.3 手動実行テスト

- APIキー依存のエンドツーエンドテスト
- 実際のAPIを使用したモデルテスト
- パフォーマンステスト

## 7. テスト実行スクリプト

| スクリプト名 | 目的 | 実行方法 |
|------------|------|---------|
| `Run-ModelTests.ps1` | AIモデルのテスト実行（Windows） | `.\Run-ModelTests.ps1 [model-type]` |
| `run-model-tests.sh` | AIモデルのテスト実行（Linux/Mac） | `./run-model-tests.sh [model-type]` |
| `test-env-logic.ps1` | 環境変数ロジックのテスト実行（Windows） | `.\test-env-logic.ps1` |

## 8. テスト結果報告

テスト結果は以下の形式で記録・報告します：

- テスト実行日時
- テスト環境情報
- 実行したテストケース数
- 成功／失敗の内訳
- 失敗したテストケースの詳細
- 発見された問題と対応策

## 9. 更新履歴

| 日付 | バージョン | 内容 | 更新者 |
|------|----------|------|--------|
| 2023-06-01 | 0.1 | 初版作成 | 開発チーム |
| 2023-08-15 | 0.2 | AIモデルテスト追加 | 開発チーム |
| 2023-10-20 | 0.3 | 環境変数管理テスト追加 | 開発チーム | 